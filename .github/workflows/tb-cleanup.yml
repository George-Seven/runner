name: TB Cleanup

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Run TB cleanup
        run: |
          API_KEY="${{ secrets.TB_API_TOKEN }}"
          BASE_URL="https://api.torbox.app/v1/api"

          GENERAL_TIMEOUT=60        # seconds
          METADATA_TIMEOUT=180      # seconds

          # Set VERBOSE=1 to enable logging
          VERBOSE="${VERBOSE:-0}"

          response=$(curl -s \
            -H "Authorization: Bearer $API_KEY" \
            "$BASE_URL/torrents/mylist")

          now=$(date +%s)

          echo "$response" | jq -c '.data[]?' | while read -r torrent; do
              id=$(echo "$torrent" | jq -r '.id')
              name=$(echo "$torrent" | jq -r '.name')
              status=$(echo "$torrent" | jq -r '.download_state')
              created=$(echo "$torrent" | jq -r '.created_at // empty')

              idle_time="unknown"
              if [[ -n "$created" ]]; then
                  created_epoch=$(date -d "$created" +%s 2>/dev/null)
                  if [[ -n "$created_epoch" ]]; then
                      idle_time=$((now - created_epoch))
                  fi
              fi

              delete=false
              action="OK"

              # States that should never be touched
              if [[ "$status" == *"cached"* || \
                    "$status" == *"downloading"* || \
                    "$status" == *"uploading"* || \
                    "$status" == *"paused"* ]]; then
                  delete=false
                  action="OK"

              # Metadata states: allow up to 180 seconds
              elif [[ "$status" == *"metaDL"* || "$status" == *"checkingResumeData"* ]]; then
                  if [[ "$idle_time" != "unknown" && "$idle_time" -ge "$METADATA_TIMEOUT" ]]; then
                      delete=true
                      action="Deleting (metadata timeout)"
                  fi

              # All other states: allow only 60 seconds
              else
                  if [[ "$idle_time" != "unknown" && "$idle_time" -ge "$GENERAL_TIMEOUT" ]]; then
                      delete=true
                      action="Deleting (state timeout)"
                  fi
              fi

              if [[ "$VERBOSE" == "1" ]]; then
                  printf "Torrent: %-8s | Status: %-25s | Idle: %s sec | Name: %s\n" \
                      "$id" "$status" "$idle_time" "$name"
                  echo "  → $action"
                  echo
              fi

              if [[ "$delete" == true ]]; then
                  curl -s -X POST \
                    -H "Authorization: Bearer $API_KEY" \
                    -H "Content-Type: application/json" \
                    -d "{\"operation\":\"delete\",\"torrent_id\":$id}" \
                    "$BASE_URL/torrents/controltorrent" \
                    > /dev/null
              fi
          done              if [[ -n "$updated" ]]; then
                  updated_epoch=$(date -d "$updated" +%s 2>/dev/null)
                  if [[ -n "$updated_epoch" ]]; then
                      idle_time=$((now - updated_epoch))
                  fi
              fi

              delete=false
              action="OK"

              # Rule 1: stalled for ≥1 minute
              if [[ "$status" == *"stalled"* ]]; then
                  if [[ "$idle_time" != "unknown" && "$idle_time" -ge "$STALL_SECONDS" ]]; then
                      delete=true
                      action="Deleting (stalled)"
                  fi
              fi

              # Rule 2: metadata/loading stuck ≥5 minutes
              if [[ "$status" == *"metadata"* || "$status" == *"loading"* ]]; then
                  if [[ "$idle_time" != "unknown" && "$idle_time" -ge "$META_SECONDS" ]]; then
                      delete=true
                      action="Deleting (metadata timeout)"
                  fi
              fi

              # Explicitly skip queued torrents
              if [[ "$status" == *"queued"* ]]; then
                  delete=false
                  action="OK"
              fi

              if [[ "$VERBOSE" == "1" ]]; then
                  printf "Torrent: %-8s | Status: %-25s | Idle: %s sec | Name: %s\n" \
                      "$id" "$status" "$idle_time" "$name"
                  echo "  → $action"
                  echo
              fi

              if [[ "$delete" == true ]]; then
                  curl -s -X POST \
                    -H "Authorization: Bearer $API_KEY" \
                    -H "Content-Type: application/json" \
                    -d "{\"operation\":\"delete\",\"torrent_id\":$id}" \
                    "$BASE_URL/torrents/controltorrent" \
                    > /dev/null
              fi
          done
